<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Hospital Management Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="dashboards.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>
    <div class="sidebar">
        <div class="profile">
            <img src="user.png" alt="Administrator">
            <h2 id="userName"></h2>
            <p id="userEmail"></p>
        </div>
        <button class="logout-btn" onclick="logout()">Log out</button>
        <nav>
            <ul>
                <li><a href="doctors.html">Doctors</a></li>
                <li><a href="schedule.html">Schedule</a></li>
                <li><a href="appointments.html">Appointment</a></li>
                <li><a href="patients.html">Patients</a></li>
            </ul>
        </nav>
    </div>

    <div class="content">
        <div class="welcome-box">
            <h4>Welcome,</h4>
            <h4><span id="userNameDisplay"></span>!</h4>
            <p>Haven't any idea about doctors? No problem! Jump into the "All Doctors" section or "Sessions". Track your past and future appointments history, and find out the expected arrival time of your doctor or medical consultant.</p>
        </div>
        <div class="count-container">
            <!-- Doctors count -->
            <div class="card bg-light border-primary text-center">
                <div class="card-body">
                    <h5 class="card-title">Total Doctors</h5>
                    <h3 id="doctorCount">0</h3>
                </div>
            </div>
            <!-- Patients count -->
            <div class="card bg-light border-success text-center">
                <div class="card-body">
                    <h5 class="card-title">Total Patients</h5>
                    <h3 id="patientCount">0</h3>
                </div>
            </div>
        </div>
        <div class="container my-4">
            <canvas id="dataChart" width="400" height="200"></canvas>
            <canvas id="lineChart"></canvas>
        </div>
    </div>

    <div class="date-time" id="dateTimeDisplay"></div>

    <div class="footer">
        <p>About: This application helps manage hospital operations efficiently.</p>
       Admin Email :<a href=""> admin@gmail.com</a> <!-- Replace with the actual admin email -->
        <p>&copy; 2024 Hospital Management System. All Rights Reserved.</p>
    </div>

    <script>
        function logout() {
            localStorage.removeItem('loggedInUser');
            // Redirect to login page
            window.location.href = "loginpage.html";
        }

        // Fetch user data from localStorage and display in the sidebar and welcome message
        document.addEventListener('DOMContentLoaded', function () {
            const user = JSON.parse(localStorage.getItem('loggedInUser'));
            if (user) {
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('userNameDisplay').textContent = user.name; // Display in center
            }

            // Fetch Doctors and Patients data from API
            fetch("https://doc-back.onrender.com/doctors")
                .then(res => res.json())
                .then(doctors => {
                    const doctorCount = doctors.length;
                    document.getElementById("doctorCount").innerText = doctorCount;
                });

            fetch("https://doc-back.onrender.com/patients")
                .then(res => res.json())
                .then(patients => {
                    const patientCount = patients.length;
                    document.getElementById("patientCount").innerText = patientCount;
                });
        });

        // Function to update date and time every second
        function updateDateTime() {
            const now = new Date();
            const dateTimeString = now.toLocaleString();
            document.getElementById('dateTimeDisplay').textContent = dateTimeString;
        }

        setInterval(updateDateTime, 1000); // Update every second
        updateDateTime(); // Initial call
        async function fetchData() {
            try {
                const [patientsRes, doctorsRes] = await Promise.all([
                    fetch("https://doc-back.onrender.com/patients"),
                    fetch("https://doc-back.onrender.com/doctors")
                ]);

                const patientsData = await patientsRes.json();
                const doctorsData = await doctorsRes.json();

                // Create a mapping for appointment dates to counts
                const patientCounts = {};
                const doctorCounts = {};

                patientsData.forEach(patient => {
                    const month = new Date(patient.appointmentDate).getMonth(); // 0-11 for Jan-Dec
                    patientCounts[month] = (patientCounts[month] || 0) + 1;
                });

                doctorsData.forEach(doctor => {
                    const month = new Date(doctor.schedule?.date).getMonth(); // 0-11 for Jan-Dec
                    doctorCounts[month] = (doctorCounts[month] || 0) + 1;
                });

                // Prepare data for the chart
                const months = Array.from({ length: 12 }, (_, i) => `Month ${i + 1}`);
                const patientData = months.map((_, i) => patientCounts[i] || 0);
                const doctorData = months.map((_, i) => doctorCounts[i] || 0);

                // Create the chart
                const ctx = document.getElementById("lineChart").getContext("2d");
                new Chart(ctx, {
                    type: "line",
                    data: {
                        labels: months,
                        datasets: [
                            {
                                label: "Number of Patients",
                                data: patientData,
                                borderColor: "rgba(75, 192, 192, 1)",
                                fill: false,
                                tension: 0.1,
                            },
                            {
                                label: "Number of Doctors",
                                data: doctorData,
                                borderColor: "rgba(255, 99, 132, 1)",
                                fill: false,
                                tension: 0.1,
                            }
                        ]
                    },
                    options: {
                        scales: {
                            x: {
                                title: { display: true, text: 'Months' },
                            },
                            y: {
                                beginAtZero: true,
                                title: { display: true, text: 'Count' },
                            },
                        }
                    }
                });
            } catch (error) {
                console.error("Error fetching data:", error);
            }
        }

        // Load chart on page load
        window.onload = fetchData;
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
            crossorigin="anonymous"></script>
</body>

</html>
